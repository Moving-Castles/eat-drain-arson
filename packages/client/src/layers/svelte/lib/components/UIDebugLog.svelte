<script lang="ts">
  import { entities } from "../../modules/entities";
  import { player, playerAddress } from "../../modules/player";
  import { seedToName } from "../../utils/name";
  import { shortenAddress } from "../../utils/ui";
  import { blockNumber } from "../../modules/network";
  import { speed, fragSpeed } from "../../modules/ui";
  import { EntityCategory } from "../../modules/entities";
  import { fade } from "svelte/transition";

  const SECONDS_IN_DAY = 86400;

  let clockTime: number;
  $: clockTime = Math.floor((($blockNumber % 3600) / 3600) * SECONDS_IN_DAY);

  function isNight(date: Date) {
    return date.getHours() > 17 || date.getHours() < 9;
  }

  function formatTime(seconds: number) {
    let currentTime = new Date(seconds * 1000);
    return (isNight(currentTime) ? "🌙 " : "🌞 ") + currentTime.toISOString().substr(11, 8);
  }
</script>

<div class="ui-debug-log">
  <div>Blocknumber: <strong>{$blockNumber}</strong></div>
  <div class="clock-time">World time: {formatTime(clockTime)}</div>
  <div>Cooldown block: {$player.coolDownBlock}</div>
  <hr />
  {#each Object.entries($entities) as [address, value], i}
    <div transition:fade={{ duration: $speed + $fragSpeed * i }} class:player={address === $playerAddress}>
      {#if value.entityCategory == EntityCategory.Player}
        <strong>👺 {seedToName($entities[address].seed)}</strong>
      {/if}
      {#if value.entityCategory == EntityCategory.Terrain}
        <strong>🗺️ {shortenAddress(address)}</strong>
      {/if}
      {#if value.entityCategory == EntityCategory.Fire}
        <strong>🔥 {shortenAddress(address)}</strong>
      {/if}
      {#if value.entityCategory == EntityCategory.Corpse}
        <strong>💀 {seedToName($entities[address].seed)}</strong>
      {/if}
      / x:{value.position?.x}
      / y: {value.position?.y}
      {#if value.entityCategory == EntityCategory.Player}
        / e: {value.energy}
      {/if}
      {#if value.coolDownBlock}
        / cdb: {value.coolDownBlock}
      {/if}
      {#if value.resource}
        / r: {value.resource}
      {/if}
    </div>
  {/each}
</div>

<style>
  .player {
    color: var(--blue);
  }
</style>
